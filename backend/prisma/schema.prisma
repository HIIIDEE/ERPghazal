generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
  MANAGER
  HR
}

enum ContractType {
  CDI
  CDD
  CDD_RENOUVELABLE
  JOURNALIER
  STAGIAIRE
  APPRENTI
  INTERIMAIRE
  INTERNSHIP // Deprecated
  FREELANCE // Deprecated
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  roles     Role[]   @default([USER])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  employee  Employee?
}

model Department {
  id        String     @id @default(uuid())
  name      String     @unique
  employees Employee[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Position {
  id        String     @id @default(uuid())
  title     String     @unique
  employees Employee[]
  history   PositionHistory[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  COHABITANT
  WIDOWER
  DIVORCED
}

enum EmployeeType {
  EMPLOYEE
  STUDENT
  TRAINEE
  CONTRACTOR
  FREELANCE
}

enum EmployeeStatus {
  ACTIVE
  SUSPENDED
  EXITED
}

enum PaymentMethod {
  VIREMENT
  ESPECE
  CHEQUE
}

model Employee {
  id           String     @id @default(uuid())
  
  // Identity
  firstName    String
  lastName     String
  jobTitle     String?
  workEmail    String     @unique
  workPhone    String?
  workMobile   String?
  
  // Work Info
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  managerId    String?
  manager      Employee?   @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates Employee[]  @relation("ManagerSubordinates")
  coachId      String?
  coach        Employee?   @relation("CoachMentees", fields: [coachId], references: [id])
  mentees      Employee[]  @relation("CoachMentees")
  
  workAddress  String?
  workLocation String?
  workingHours String?
  timezone     String?     @default("UTC")

  // Private Info
  privateEmail       String?
  phone              String?
  address            String?
  nationality        String?
  identificationId   String?
  passportId         String?
  gender             Gender?
  birthday           DateTime?
  placeOfBirth       String?
  countryOfBirth     String?
  maritalStatus      MaritalStatus?
  children           Int?       @default(0)
  emergencyContact   String?
  emergencyPhone     String?
  bankAccount        String?
  paymentMethod      PaymentMethod?

  // HR Settings
  status       EmployeeStatus @default(ACTIVE)
  employeeType EmployeeType @default(EMPLOYEE)
  userId       String?    @unique
  user         User?      @relation(fields: [userId], references: [id])
  pin          String?
  badgeId      String?
  
  // CNAS Info
  socialSecurityNumber String?
  cnasAgency           String?
  cnasStartDate        DateTime?
  isHandicapped        Boolean    @default(false)
  cnasContribution     Boolean    @default(true)
  cnasRateSalary       String?
  cnasRatePatron       String?
  cnasRateSocial       String?
  cnasRateHousing      String?
  cnasRateCacobath     String?
  cnasRateService      String?
  cnasMutual           String?


  // Relations
  positionId   String?
  position     Position?   @relation(fields: [positionId], references: [id])
  positionHistory PositionHistory[]

  contracts    Contract[]
  attendances  Attendance[]
  leaves       LeaveRequest[]
  absences     Absence[]
  documents    Document[]
  bonuses      EmployeeBonus[]
  payslips     Payslip[]

  hireDate     DateTime
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model PositionHistory {
  id          String    @id @default(uuid())
  startDate   DateTime
  endDate     DateTime?
  
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  
  positionId  String
  position    Position  @relation(fields: [positionId], references: [id])
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum ContractStatus {
  DRAFT
  RUNNING
  TO_RENEW
  EXPIRED
}

enum WorkSchedule {
  FIVE_DAYS
  SIX_DAYS
}



enum CnasScheme {
  GENERAL
  CADRE
  NON_ASSUJETTI
}

enum FiscalScheme {
  IMPOSABLE
  EXONERE
  ABATTEMENT_40
}

enum ExecutiveStatus {
  CADRE
  NON_CADRE
  MAITRISE
}

model Contract {
  id          String         @id @default(uuid())
  reference   String?        // Manual identifier e.g. "CT-2024-001"
  status      ContractStatus @default(DRAFT)
  type        ContractType
  startDate   DateTime
  endDate     DateTime?
  
  // Compensation
  wage        Float          // salaire_base
  hourlyWage  Float?         // salaire_horaire
  weeklyHours Int?           // duree_hebdomadaire
  
  // Classification
  classification String?
  coefficient    String?     // string or int
  
  // Perks
  benefits       Json?       // avantages_nature
  
  // Schemes
  cnasScheme     CnasScheme?    @default(GENERAL)
  fiscalScheme   FiscalScheme?  @default(IMPOSABLE)
  executiveStatus ExecutiveStatus? @default(NON_CADRE)
  
  // Trial
  trialPeriodDuration Int?   // in days
  trialPeriodEndDate DateTime? // Keep for legacy or calculated
  
  // Legacy fields
  workingSchedule    String?   // e.g. "Standard 40h/week"
  workSchedule       WorkSchedule @default(FIVE_DAYS)
  scheduledPay       String?   // e.g. "Monthly"
  
  // Relations
  employeeId  String
  employee    Employee       @relation(fields: [employeeId], references: [id])
  
  // Amendments
  previousContractId String?   @unique // One-to-one for chain
  previousContract   Contract? @relation("ContractHistory", fields: [previousContractId], references: [id])
  nextContract       Contract? @relation("ContractHistory")

  fileUrl     String?
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model Attendance {
  id          String    @id @default(uuid())
  date        DateTime
  checkIn     DateTime?
  checkOut    DateTime?
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model LeaveRequest {
  id          String      @id @default(uuid())
  type        String
  startDate   DateTime
  endDate     DateTime
  reason      String?
  status      LeaveStatus @default(PENDING)
  employeeId  String
  employee    Employee    @relation(fields: [employeeId], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Candidate {
  id          String   @id @default(uuid())
  firstName   String
  lastName    String
  email       String   @unique
  phone       String?
  resumeUrl   String?
  status      String   @default("APPLIED")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Document {
  id          String   @id @default(uuid())
  name        String
  url         String
  type        String
  employeeId  String?
  employee    Employee? @relation(fields: [employeeId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum BonusCalculationMode {
  FIXE
  POURCENTAGE
}

enum BonusFrequency {
  MONTHLY
  PONCTUELLE
}

model PayrollBonus {
  id              String   @id @default(uuid())
  name            String
  calculationMode BonusCalculationMode
  amount          Float?
  percentage      Float?
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employeeBonuses EmployeeBonus[]
}

model EmployeeBonus {
  id          String       @id @default(uuid())
  employeeId  String
  employee    Employee     @relation(fields: [employeeId], references: [id])
  bonusId     String
  bonus       PayrollBonus @relation(fields: [bonusId], references: [id])
  
  // Assignment Details
  startDate   DateTime
  endDate     DateTime?
  amount      Float?       // Overridden amount or calculated value
  frequency   BonusFrequency @default(MONTHLY)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Removed unique constraint to allow multiple one-off bonuses
  // @@unique([employeeId, bonusId])
}

model AbsenceReason {
  id           String    @id @default(uuid())
  name         String
  isAuthorized Boolean   @default(true)
  absences     Absence[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Absence {
  id          String   @id @default(uuid())
  date        DateTime
  isFullDay   Boolean  @default(false)
  hours       Float?
  startTime   String?
  endTime     String?
  reason      String?  // Keep for backward compatibility or custom notes

  reasonRelId String?
  reasonRel   AbsenceReason? @relation(fields: [reasonRelId], references: [id])

  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SocialContribution {
  id              String   @id @default(uuid())
  name            String   @unique
  code            String   @unique // Ex: SS_EMPLOYEE, SS_EMPLOYER, RETIREMENT_EMPLOYEE, etc.
  type            String   // EMPLOYEE or EMPLOYER
  rate            Float    // Percentage (ex: 9 for 9%)
  description     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Payslip {
  id              String   @id @default(uuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])

  month           Int      // 0-11 (January = 0)
  year            Int

  // Salary breakdown
  baseSalary      Float
  bonuses         Float    @default(0)
  grossSalary     Float    @default(0) // Salaire brut = base + bonuses

  // Employee contributions (déduites du brut)
  employeeContributions Json? // { "SS_EMPLOYEE": 12600, "RETIREMENT_EMPLOYEE": 7000, ... }
  totalEmployeeContributions Float @default(0)

  // Taxable salary
  taxableSalary   Float    @default(0) // Salaire imposable = brut - cotisations employé

  // Tax (IRG)
  incomeTax       Float    @default(0) // IRG

  // Net salary
  netSalary       Float    // Net = imposable - IRG

  // Employer contributions (déclaratives)
  employerContributions Json? // { "SS_EMPLOYER": 36400, "RETIREMENT_EMPLOYER": 10000, ... }
  totalEmployerContributions Float @default(0)

  status          String   @default("DRAFT") // DRAFT, VALIDATED, PAID

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([employeeId, month, year])
}
